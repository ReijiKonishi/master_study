%!TEX root = ../thesis.tex

\section{推定アルゴリズム}
\label{part:algorithm}

本章では、定義\ref{prop_model}による提案モデルが
定理\ref{theo:prop_identifiability}の識別可能条件を満たす時に、
因果順序とDAGにおける変数間の関係性の強さを推定するアルゴリズムを提案する。
推定アルゴリズムは、
(i) 各変数の因果順序を推定するステップ、と
(ii) 各変数の親変数との関係性の強さを推定するステップ、
という2つのステップによって構成される。
提案モデルには異なるデータ生成過程に従う連続変数と離散変数が混在しているため、
(i)因果順序を推定するステップ は、連続変数と離散変数を分けて逐次的に求める。
以下では、連続変数と離散変数の因果順序の推定法についてそれぞれ述べる。

まず、離散変数の因果順序の推定法について述べる。
離散変数の因果順序は、以下で定義される各頂点のモーメント比スコアを比較することで推定する。
\begin{equation}
  \begin{split}
    \widehat{\mathcal S}(1,j) &\equiv
          \frac{\widehat{E}(X_j^2)}{\beta_0 \widehat{E}(X_j) + (\beta_1 + 1)\widehat{E}(X_j)^2} \\
          \\
    \widehat{\mathcal S}(m,j) &\equiv
          \frac{\widehat{E}(X_j^2)}
          {\widehat{E}(\beta_0 \widehat{E}(X_j | X_{\widehat{\pi}_{1:(m-1)}}) +
          (\beta_1 + 1)\widehat{E}(X_j | X_{\widehat{\pi}_{1:(m-1)}})^2)}
  \end{split}
  \label{alg:MRS}
\end{equation}
ここで、各推定量は以下のように求める。
\begin{align*}
  \widehat{E}(X_j)
      &= \tfrac{1}{n}\textstyle \sum_{i=1}^n X_j^{(i)} \\
  \widehat{E}(\widehat{E}(X_j | X_S))
      &= \tfrac{1}{n}\textstyle \sum_{i=1}^n g_j(\widehat{\theta}_j^S +
         \textstyle \sum_{k\in S} \widehat{\theta}_{jk}^S X_k^{(i)}) \\
  \widehat{E}(\widehat{E}(X_j | X_S)^2)
      &= \tfrac{1}{n}\textstyle \sum_{i=1}^n \{g_j(\widehat{\theta}_j^S +
         \textstyle \sum_{k\in S} \widehat{\theta}_{jk}^S X_k^{(i)})\}^2
\end{align*}
ここで$(\widehat{\theta}_j^S, \widehat{\theta}_{jk}^S)$は、
$X_j$を目的変数、$X_S$を説明変数にとった一般化線形モデルのパラメーを最尤推定した値である。
つまり、離散変数の因果順序を推定する際は、事前に各離散変数の条件付き確率分布を仮定する必要がある。

式~\eqref{alg:MRS}によるモーメント比スコアは、式~\eqref{prop_MRS}の推定量であるため、
正しい因果順序の要素のスコアは1に等しくなり、それ以外の場合は1より大きくなる。
つまり、モーメント比スコアが最小となる頂点のスコアが1に等しい場合は、
因果順序が$m$番目の要素は離散変数であり、その変数を特定することができる。
一方で、全てのモーメント比スコアが1より大きい場合は、因果順序が$m$番目の要素は連続変数であることが分かる。
ただし、推定誤差があるためモーメント比スコアが厳密に1となることはない。
そのため、本論文では閾値を設定することでモーメント比スコアが1に等しいかどうかを判断する。

次に、連続変数の因果順序の推定法について述べる。
因果順序$m$番目の頂点が連続変数である場合、
定理\ref{theo:prop_identifiability}の条件(A)により、
因果順序$m$番目の要素の条件付き分散は、
連続変数が割り当てられた他のどの頂点の条件付き分散よりも厳密に小さい。
つまり、因果順序$m$番目の要素が連続変数である場合は、
$S =\{\widehat{\pi}_1, \dots, \widehat{\pi}_{m-1}\}$を与えたときの
各頂点の条件付き分散$\widehat{\sigma}_{j|S}$が
最小となる頂点$j \in C$が因果順序$m$番目の要素であると推定できる。
条件付き分散の一致推定量は、一般化線形モデルや一般化加法モデルなどの回帰モデルによって得ることができる。
提案モデルにおける連続変数のデータ生成過程が親変数と誤差変数との線形和であるため、
本論文では、$X_j$を目的変数に、$X_S$を説明変数にとり、
最小二乗法を用いて線形回帰分析を行ったときの残差の分散で
条件付き分散$\mathrm{Var}(X_j|X_S)$を推定する。

続いて、(ii)各変数の親変数との関係性の強さを推定するステップ について述べる。
上述の方法により因果順序$\widehat{\pi}$を推定すると、
因果順序に従って回帰分析を行うことにより、変数間の関係性の強さを表す
パラメータ$\theta_{jk}$を推定する。
具体的には、$X_{\pi_j}$を目的変数に、
$X_S = \{ X_{\widehat{\pi}_1}, \dots, X_{\widehat{\pi}_{j-1}}\}$を説明変数にとった
一般化線形モデルのパラメータを最尤法によって推定する。
ただし、パラメータ$\theta_{jk}$の値が実際には0であっても、
最尤法による推定値は厳密には0にならず、本来は存在しない冗長な有向辺が残ってしまう。
そこで、Shimizu \textit{et al.}(2011)\cite{Shimizu2011-pd}のように
adaptive Lasso\cite{Zou2006-pi}を用いることで冗長な有向辺を削除する。
adaptive Lassoではサンプルサイズが十分大きければ、
親変数候補$X_S = \{ X_{\widehat{\pi}_1}, \dots, X_{\widehat{\pi}_{j-1}}\}$の中から
正しい親変数を選択することができる。
つまり、$\theta_{jk} \neq 0$となるような変数の集合$X_K \subset X_S$を見つけることができる。

提案モデルには連続変数と離散変数が混在している。
そのため、adaptive Lassoによる推定値は、それぞれ以下の目的関数を最小化することによって求める。

\begin{itemize}
  \item
    連続変数
    \begin{equation}
      \label{adalasso_C}
      \left\| X_j - \sum_{k \in S} \theta_{jk}X_k \right\|^2
        + \lambda \sum_{k\in S} \frac{|\theta_{jk}|}{|\widehat{\theta}_{jk}|^\gamma}
    \end{equation}
  \item
    離散変数
    \begin{equation}
      \label{adalasso_D}
      \sum_{i=1}^n \left( -X_j^{(i)}\left( \theta_j + \sum_{k\in S}\theta_{jk}X_k^{(i)} \right)
        + g_j\left( \theta_j + \sum_{k\in S}\theta_{jk}X_k^{(i)} \right) \right)
        + \lambda \sum_{k\in S} \frac{|\theta_{jk}|}{|\widehat{\theta}_{jk}|^\gamma}
    \end{equation}
\end{itemize}

ここで$\lambda$と$\gamma$は調整パラメータであり、
$\widehat{\theta}_{jk}$は$\theta_{jk}$の一致推定量による推定値である。
Zou(2006)\cite{Zou2006-pi}では、
調整パラメータは5分割交差検証(5-fold cross-validation)によって選択し、
$\widehat{\theta}_{jk}$は最小二乗法または最尤法によって推定することが提案されている。


\begin{algorithm}[t]
    \caption{提案モデルの推定アルゴリズム}
    \label{alg1}
    \begin{algorithmic}    %行番号をつけないときは[1]は不要
      \REQUIRE 提案モデルから生成された$n$個のi.i.d標本 $X^{1:n}$、
               各離散変数の条件付き確率分布の仮定
      \ENSURE 因果順序$\widehat{\pi}=(\widehat{\pi}_1, \dots, \widehat{\pi}_p)$、
              グラフ構造$\widehat{E} \in \{ 0,1\}^{p \times p}$、
              頂点間の関係性の強さ$\widehat{\theta} \in \mathbb R^{p \times p}$

      \STATE \underline{Step1: 因果順序の推定}
      \STATE 初期化 $\widehat{\pi}_0 = \emptyset$

      \FOR{$m = \{ 1,2,\dots, p\}$}
      \STATE $S = \{ \widehat{\pi}_0, \dots, \widehat{\pi}_{m-1} \}$
        \FOR{$j \in \{ V \backslash S \} \cap D$}
        \STATE 式~\eqref{alg:MRS}を用いて$\widehat{\mathcal S}(m,j)$を計算する
        \ENDFOR

        \IF{$\min \widehat{\mathcal S}(m,j) < \text{閾値}$}
        \STATE 因果順序$m$番目の要素を推定 $\widehat{\pi}_m = \argmin_{j} \widehat{\mathcal S}(m,j)$
        \ELSE
          \FOR{$j \in \{ V \backslash S \} \cap C$}
          \STATE $X_S$による$X_j$の条件付き分散 $\widehat{\sigma}_{j|S}^2$を計算する
          \ENDFOR
        \STATE 因果順序$m$番目の要素を推定 $\widehat{\pi}_m = \argmin_{j} \widehat{\sigma}_{j|S}^2$
        \ENDIF
      \ENDFOR

      \STATE \underline{Step2: 変数間の関係性の強さの推定}
      \FOR{$m = \{ 2,3, \dots ,p\}$}
      \STATE $K = \{ \widehat{\pi}_1, \dots, \widehat{\pi}_{m-1} \}$
      \STATE 目的変数 $X_{\widehat{\pi}_m}$、説明変数 $X_K$とし、
             adaptive Lasso\eqref{adalasso_C}\eqref{adalasso_D}を用いて
             $\widehat{\theta}_{mk}$を求める
      \STATE 因果順序$m$番目の要素の親変数を推定
             $\widehat{Pa}(\widehat{\pi}_m) = \{ k \in K \>|\> \widehat{\theta}_{mk} \neq 0 \}$
      \ENDFOR
      \STATE グラフ構造を推定
      $\widehat{E} = \bigcup_{m\in V}\{ (k,\widehat{\pi}_m)
      \>|\> k \in \widehat{Pa}(\widehat{\pi}_m) \}$

    \end{algorithmic}
\end{algorithm}
